{
  "owner": "power-IoT-terminal",
  "repo": "power-iot-traffic",
  "branch": "main",
  "message": "feat: 完善命令式弹窗体系 (1/3)",
  "files": [
    {
      "path": "src/App.vue",
      "content": "<template>\n  <a-config-provider :theme=\"themeConfig\" :locale=\"locale\">\n    <MxModalProvider>\n      <router-view />\n    </MxModalProvider>\n  </a-config-provider>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed } from 'vue'\nimport zhCN from 'ant-design-vue/es/locale/zh_CN'\nimport { useThemeStore } from '@/store/theme'\nimport { MxModalProvider } from '@/components/MxModal'\n\n// 主题 store\nconst themeStore = useThemeStore()\n\n// 主题配置\nconst themeConfig = computed(() => themeStore.themeConfig)\n\n// 语言配置 - 使用中文\nconst locale = zhCN\n</script>\n"
    },
    {
      "path": "src/components/MxModal/MxModalProvider.vue",
      "content": "<!--\n * @Author: liaokt\n * @Description: Modal Provider 组件，用于全局管理 Modal 状态\n * @Date: 2025-11-13 11:30:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 11:30:00\n-->\n<template>\n  <slot />\n  <teleport to=\"body\">\n    <component :is=\"modal.component\" v-for=\"modal in modals\" :key=\"modal.id\" v-bind=\"modal.props\" />\n  </teleport>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, provide, onMounted, onUnmounted, markRaw, type Component } from 'vue'\nimport { setGlobalProvider } from './modalRegistry'\n\ndefineOptions({\n  name: 'MxModalProvider'\n})\n\ninterface ModalInstance {\n  id: string\n  component: Component\n  props: Record<string, any>\n}\n\nconst modals = ref<ModalInstance[]>([])\n\n/** 注册 Modal */\nconst register = (id: string, component: Component, props: Record<string, any> = {}) => {\n  const existingIndex = modals.value.findIndex(m => m.id === id)\n  if (existingIndex >= 0) {\n    // 更新已存在的 Modal\n    modals.value[existingIndex].props = { ...modals.value[existingIndex].props, ...props }\n  } else {\n    // 添加新的 Modal，使用 markRaw 避免组件被响应式化\n    modals.value.push({ id, component: markRaw(component), props })\n  }\n}\n\n/** 移除 Modal */\nconst unregister = (id: string) => {\n  const index = modals.value.findIndex(m => m.id === id)\n  if (index >= 0) {\n    modals.value.splice(index, 1)\n  }\n}\n\n/** 更新 Modal Props */\nconst update = (id: string, props: Partial<Record<string, any>>) => {\n  const modal = modals.value.find(m => m.id === id)\n  if (modal) {\n    modal.props = { ...modal.props, ...props }\n  }\n}\n\n/** 移除所有 Modal */\nconst removeAll = () => {\n  modals.value = []\n}\n\nconst provider = {\n  register,\n  unregister,\n  update,\n  removeAll\n}\n\n// 提供给子组件使用（通过 inject）\nprovide('mxModal', provider)\n\n// 设置全局 provider（用于非组件上下文）\nonMounted(() => {\n  setGlobalProvider(provider)\n})\n\nonUnmounted(() => {\n  setGlobalProvider(null as any)\n})\n</script>\n"
    },
    {
      "path": "src/components/MxModal/index.ts",
      "content": "/*\n * @Author: liaokt\n * @Description: MxModal 模块导出和全局 API\n * @Date: 2025-11-13 11:30:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 12:30:00\n */\nimport MxModalProvider from './MxModalProvider.vue'\n\n// 从 modalRegistry 重新导出，避免循环依赖\nexport { modalRegistry, register, show, hide, remove, removeAll } from './modalRegistry'\n\nexport { MxModalProvider }\nexport { useModal, useModalController, type UseModalReturn } from './useModal'\nexport { default as MxModal } from './MxModal.vue'\nexport { default as MxFormModal } from './MxFormModal.vue'\nexport { default as MxDetailModal } from './MxDetailModal.vue'\n"
    },
    {
      "path": "src/components/MxModal/modalRegistry.ts",
      "content": "/*\n * @Author: liaokt\n * @Description: Modal 注册表和相关函数，避免循环依赖\n * @Date: 2025-11-13 12:30:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 14:16:51\n */\nimport { defineComponent, h, watch, type Component } from 'vue'\nimport type { UseModalReturn } from './useModal'\n\n// Modal 注册表\nexport const modalRegistry = new Map<string, Component>()\n\n// 当前显示的 Modal 实例映射 (instanceId -> modal instance)\nexport const modalInstances = new Map<string, UseModalReturn>()\n\n// 全局存储 provider 实例（由 MxModalProvider 设置）\nlet globalProvider: {\n  register: (id: string, component: Component, props?: Record<string, any>) => void\n  unregister: (id: string) => void\n  update: (id: string, props: Partial<Record<string, any>>) => void\n  removeAll: () => void\n} | null = null\n\n/** 设置全局 Provider（由 MxModalProvider 调用） */\nexport function setGlobalProvider(provider: {\n  register: (id: string, component: Component, props?: Record<string, any>) => void\n  unregister: (id: string) => void\n  update: (id: string, props: Partial<Record<string, any>>) => void\n  removeAll: () => void\n}) {\n  globalProvider = provider\n}\n\n/** 获取 Modal Provider 的方法 */\nfunction getModalProvider() {\n  if (!globalProvider) {\n    console.warn('MxModalProvider 未找到，请确保在 App 中包裹 MxModalProvider')\n    return {\n      register: () => {\n        console.warn('MxModalProvider 未找到，无法注册 Modal')\n      },\n      unregister: () => {},\n      update: () => {},\n      removeAll: () => {}\n    }\n  }\n  return globalProvider\n}\n\n/**\n * 注册 Modal 组件\n */\nexport function register(id: string, component: Component) {\n  modalRegistry.set(id, component)\n}\n\n/**\n * 显示 Modal\n */\nexport async function show<T = any>(id: string, args?: Record<string, any>): Promise<T | null> {\n  const component = modalRegistry.get(id)\n  if (!component) {\n    throw new Error(`Modal \"${id}\" 未注册`)\n  }\n\n  const provider = getModalProvider()\n  const instanceId = `${id}-${Date.now()}-${Math.random()}`\n\n  // 动态导入 useModal，避免循环依赖\n  const { useModal } = await import('./useModal')\n  const modal = useModal()\n\n  return new Promise<T | null>((resolve, reject) => {\n    // 设置初始参数\n    if (args) {\n      modal.args.value = { ...args }\n    }\n\n    // 注入 resolve/reject 到 modal 实例\n    ;(modal as any)._resolve = (value: T) => {\n      ;(modal as any)._resolved = true\n      resolve(value)\n      provider.unregister(instanceId)\n      modalInstances.delete(instanceId)\n    }\n    ;(modal as any)._reject = (reason?: any) => {\n      reject(reason)\n      provider.unregister(instanceId)\n      modalInstances.delete(instanceId)\n    }\n\n    // 监听 visible 变化，处理取消情况\n    watch(\n      () => modal.visible.value,\n      visible => {\n        if (!visible && !(modal as any)._resolved) {\n          // 用户关闭了 Modal（非 resolve），resolve null\n          setTimeout(() => {\n            if (!(modal as any)._resolved) {\n              ;(modal as any)._resolved = true\n              resolve(null)\n              provider.unregister(instanceId)\n              modalInstances.delete(instanceId)\n            }\n          }, 300) // 等待动画完成\n        }\n      }\n    )\n\n    // 创建包装组件\n    const wrapperComponent = defineComponent({\n      setup() {\n        // 显示 Modal\n        modal.show(args)\n\n        return () =>\n          h(component, {\n            modal,\n            ...modal.args.value\n          })\n      }\n    })\n\n    // 注册到 Provider\n    provider.register(instanceId, wrapperComponent, {})\n    modalInstances.set(instanceId, modal)\n  })\n}\n\n/**\n * 隐藏 Modal\n */\nexport function hide(id: string) {\n  // 找到所有匹配的实例并隐藏\n  for (const [instanceId, modal] of modalInstances.entries()) {\n    if (instanceId.startsWith(`${id}-`)) {\n      modal.hide()\n    }\n  }\n}\n\n/**\n * 移除 Modal\n */\nexport function remove(id: string) {\n  const provider = getModalProvider()\n  // 找到所有匹配的实例并移除\n  const toRemove: string[] = []\n  for (const instanceId of modalInstances.keys()) {\n    if (instanceId.startsWith(`${id}-`)) {\n      toRemove.push(instanceId)\n    }\n  }\n  toRemove.forEach(instanceId => {\n    provider.unregister(instanceId)\n    modalInstances.delete(instanceId)\n  })\n}\n\n/**\n * 移除所有 Modal\n */\nexport function removeAll() {\n  const provider = getModalProvider()\n  provider.removeAll()\n  modalInstances.clear()\n}\n"
    },
    {
      "path": "src/components/MxModal/useModal.ts",
      "content": "/*\n * @Author: liaokt\n * @Description: useModal Hook - 管理单个 Modal 的状态\n * @Date: 2025-11-13 11:30:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 11:30:00\n */\nimport { ref, toRaw, type Ref, type Component } from 'vue'\n\n// 从 modalRegistry 导入，避免循环依赖\nimport { modalRegistry, register, show, hide, remove } from './modalRegistry'\n\nexport interface UseModalReturn {\n  /** Modal 是否可见 */\n  visible: Ref<boolean>\n  /** Modal 参数 */\n  args: Ref<Record<string, any>>\n  /** 显示 Modal */\n  show: (args?: Record<string, any>) => void\n  /** 隐藏 Modal */\n  hide: () => void\n  /** 移除 Modal（从 DOM 中移除） */\n  remove: () => void\n  /** 更新参数 */\n  update: (args: Partial<Record<string, any>>) => void\n  /** 解析 Promise（用于命令式调用） */\n  resolve: (value: any) => void\n  /** 拒绝 Promise（用于命令式调用） */\n  reject: (reason?: any) => void\n  /** 获取业务数据（排除 a-modal 的常用参数） */\n  getFormData: <T = Record<string, any>>(keys?: string[]) => T\n  /** 获取 a-modal 的参数 */\n  getModalProps: () => Record<string, any>\n}\n\nexport interface UseModalController<T = any> {\n  /** 显示 Modal */\n  show: (args?: Record<string, any>) => Promise<T | null>\n  /** 隐藏 Modal */\n  hide: () => void\n  /** 移除 Modal */\n  remove: () => void\n}\n\n/**\n * useModal Hook - 用于在 Modal 组件内部管理状态\n *\n * @example\n * ```vue\n * <template>\n *   <a-modal\n *     :open=\"modal.visible.value\"\n *     @cancel=\"modal.hide()\"\n *     @after-close=\"modal.remove()\"\n *   >\n *     <h1>这是一个 Modal</h1>\n *   </a-modal>\n * </template>\n *\n * <script setup lang=\"ts\">\n * import { useModal } from '@/components/MxModal/useModal'\n *\n * const modal = useModal()\n * </script>\n * ```\n */\nexport function useModal(): UseModalReturn {\n  const visible = ref(false)\n  const args = ref<Record<string, any>>({})\n  let resolveFn: ((value: any) => void) | null = null\n  let rejectFn: ((reason?: any) => void) | null = null\n\n  const show = (newArgs?: Record<string, any>) => {\n    if (newArgs) {\n      args.value = { ...args.value, ...newArgs }\n    }\n    visible.value = true\n  }\n\n  const hide = () => {\n    visible.value = false\n  }\n\n  const remove = () => {\n    visible.value = false\n    args.value = {}\n    resolveFn = null\n    rejectFn = null\n  }\n\n  const update = (newArgs: Partial<Record<string, any>>) => {\n    args.value = { ...args.value, ...newArgs }\n  }\n\n  let modalInstance: any = null\n\n  const resolve = (value: any) => {\n    // 优先使用注入的 _resolve（来自 modalRegistry）\n    // modalRegistry 会将 _resolve 注入到返回对象上\n    if (modalInstance?._resolve) {\n      modalInstance._resolve(value)\n      return\n    }\n    // 否则使用本地的 resolveFn\n    if (resolveFn) {\n      resolveFn(value)\n      resolveFn = null\n    }\n  }\n\n  const reject = (reason?: any) => {\n    if (rejectFn) {\n      rejectFn(reason)\n      rejectFn = null\n    }\n  }\n\n  // a-modal 的常用参数列表（用于区分业务数据和 Modal 参数）\n  const modalPropKeys = [\n    'title',\n    'width',\n    'okText',\n    'cancelText',\n    'maskClosable',\n    'keyboard',\n    'centered',\n    'closable',\n    'destroyOnClose',\n    'footer',\n    'okType',\n    'cancelButtonProps',\n    'okButtonProps',\n    'confirmLoading',\n    'zIndex',\n    'wrapClassName',\n    'getContainer',\n    'mask',\n    'maskStyle',\n    'bodyStyle',\n    'wrapStyle',\n    'class',\n    'style',\n    'data' // data 用于包裹业务数据，不应该被包含在表单数据中\n  ]\n\n  /** 获取业务数据（排除 a-modal 的参数） */\n  const getFormData = <T = Record<string, any>>(keys?: string[]): T => {\n    // 使用 toRaw 避免响应式追踪导致的循环\n    const allArgs = toRaw(args.value)\n    if (keys) {\n      // 如果指定了 keys，只返回这些字段\n      const result: Record<string, any> = {}\n      keys.forEach(key => {\n        if (key in allArgs) {\n          result[key] = allArgs[key]\n        }\n      })\n      return result as T\n    }\n    // 否则排除所有 a-modal 的参数\n    const result: Record<string, any> = {}\n    Object.keys(allArgs).forEach(key => {\n      if (!modalPropKeys.includes(key)) {\n        result[key] = allArgs[key]\n      }\n    })\n    return result as T\n  }\n\n  /** 获取 a-modal 的参数 */\n  const getModalProps = (): Record<string, any> => {\n    // 使用 toRaw 避免响应式追踪导致的循环\n    const allArgs = toRaw(args.value)\n    const result: Record<string, any> = {}\n    Object.keys(allArgs).forEach(key => {\n      if (modalPropKeys.includes(key)) {\n        result[key] = allArgs[key]\n      }\n    })\n    return result\n  }\n\n  const result = {\n    visible,\n    args,\n    show,\n    hide,\n    remove,\n    update,\n    resolve,\n    reject,\n    getFormData,\n    getModalProps\n  } as UseModalReturn & { _resolve?: (value: any) => void; _reject?: (reason?: any) => void }\n\n  // 让 resolve 函数能够访问返回对象上的 _resolve\n  modalInstance = result\n\n  return result\n}\n\n/**\n * useModalController - 用于创建 Modal 控制器（命令式使用）\n *\n * @example\n * ```ts\n * import { useModalController } from '@/components/MxModal'\n * import UserModal from './UserModal.vue'\n *\n * const modal = useModalController(UserModal)\n *\n * // 显示 Modal\n * const result = await modal.show({ name: '', age: 0 })\n *\n * if (result) {\n *   console.log('提交的数据:', result)\n * }\n * ```\n */\n// 获取模块函数\nfunction getModalModule() {\n  return {\n    modalRegistry,\n    register,\n    show,\n    hide,\n    remove\n  }\n}\n\nexport function useModalController<T = any>(component: Component): UseModalController<T> {\n  // 生成唯一 ID（使用组件名称或生成唯一 ID）\n  const componentName =\n    (component as any).__name ||\n    (component as any).name ||\n    `Modal${Date.now()}${Math.random().toString(36).substr(2, 9)}`\n  const componentId = `modal-${componentName}`\n\n  // 确保模块已加载并注册组件\n  let isRegistered = false\n  let registrationPromise: Promise<void> | null = null\n\n  return {\n    show: async (args?: Record<string, any>) => {\n      const module = getModalModule()\n      if (!isRegistered) {\n        if (!registrationPromise) {\n          registrationPromise = (async () => {\n            if (!module.modalRegistry.has(componentId)) {\n              module.register(componentId, component)\n            }\n            isRegistered = true\n          })()\n        }\n        await registrationPromise\n      }\n      return module.show(componentId, args) as Promise<T | null>\n    },\n    hide: () => {\n      const module = getModalModule()\n      module.hide(componentId)\n    },\n    remove: () => {\n      const module = getModalModule()\n      module.remove(componentId)\n    }\n  }\n}\n"
    },
    {
      "path": "src/components/MxModal/MxModal.vue",
      "content": "<!--\n * @Author: liaokt\n * @Description: 封装的 a-modal 组件，基于 MxModal 系统\n * @Date: 2025-11-13 12:00:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 16:50:11\n-->\n<template>\n  <a-modal\n    :open=\"modal.visible.value\"\n    v-bind=\"modalProps\"\n    :body-style=\"{ paddingTop: '10px' }\"\n    @cancel=\"handleCancel\"\n    @ok=\"handleOk\"\n    @after-close=\"modal.remove()\"\n  >\n    <slot />\n    <template v-if=\"hasFooterSlot\" #footer>\n      <slot name=\"footer\" />\n    </template>\n  </a-modal>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed, useSlots } from 'vue'\nimport { useModal, type UseModalReturn } from './useModal'\nimport type { ModalProps } from 'ant-design-vue'\n\ndefineOptions({\n  name: 'MxModal'\n})\n\ninterface Props {\n  /** Modal 实例（从 modalRegistry 传递） */\n  modal?: UseModalReturn\n  /** 是否显示确认按钮 */\n  showOk?: boolean\n  /** 是否显示取消按钮 */\n  showCancel?: boolean\n  /** 自定义确认按钮文字 */\n  okText?: string\n  /** 自定义取消按钮文字 */\n  cancelText?: string\n  /** 确认按钮加载状态 */\n  confirmLoading?: boolean\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  modal: undefined,\n  showOk: true,\n  showCancel: true,\n  okText: '确定',\n  cancelText: '取消'\n})\n\nconst emit = defineEmits<{\n  ok: []\n  cancel: []\n}>()\n\n// 如果传递了 modal prop，使用它；否则创建新的实例\nconst modal = props.modal || useModal()\nconst slots = useSlots()\nconst hasFooterSlot = computed(() => Boolean(slots.footer))\n\n// 获取 a-modal 的参数（自动提取）\n// 使用 toRaw 避免响应式循环\nconst modalProps = computed<ModalProps>(() => {\n  const modalPropsFromArgs = modal.getModalProps()\n  const footerFromArgs = modalPropsFromArgs.footer\n  let footer: ModalProps['footer']\n\n  if (footerFromArgs !== undefined) {\n    footer = footerFromArgs\n  } else if (hasFooterSlot.value) {\n    footer = undefined\n  } else if (props.showOk || props.showCancel) {\n    footer = undefined\n  } else {\n    footer = null\n  }\n\n  return {\n    title: '提示',\n    width: 520,\n    okText: props.okText,\n    cancelText: props.cancelText,\n    confirmLoading: props.confirmLoading,\n    ...modalPropsFromArgs, // 从 args 中获取的参数会覆盖默认值\n    footer\n  }\n})\n\n// 处理确认\nconst handleOk = () => {\n  emit('ok')\n  // 由外部决定是否关闭（MxFormModal 会处理）\n}\n\n// 处理取消\nconst handleCancel = () => {\n  emit('cancel')\n  // 取消时总是关闭\n  modal.hide()\n}\n</script>\n"
    },
    {
      "path": "src/components/MxModal/MxFormModal.vue",
      "content": "<!--\n * @Author: liaokt\n * @Description: 封装的表单 Modal 组件，基于 MxModal 系统\n * @Date: 2025-11-13 12:00:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 16:03:17\n-->\n<template>\n  <MxModal :modal=\"modal\" @ok=\"handleOk\" @cancel=\"handleCancel\">\n    <a-form\n      ref=\"formRef\"\n      :model=\"formData\"\n      :rules=\"rules\"\n      :layout=\"layout\"\n      :label-col=\"labelCol\"\n      :wrapper-col=\"wrapperCol\"\n    >\n      <slot :form-data=\"formData\" />\n    </a-form>\n  </MxModal>\n</template>\n\n<script setup lang=\"ts\">\nimport { reactive, ref, watch, nextTick, toRaw, watchEffect } from 'vue'\nimport { useModal, type UseModalReturn } from './useModal'\nimport MxModal from './MxModal.vue'\nimport type { FormInstance, Rule } from 'ant-design-vue/es/form'\n\ndefineOptions({\n  name: 'MxFormModal'\n})\n\ninterface Props {\n  /** Modal 实例（从 modalRegistry 传递） */\n  modal?: UseModalReturn\n  /** 表单验证规则 */\n  rules?: Record<string, Rule[]>\n  /** 表单布局 */\n  layout?: 'horizontal' | 'vertical' | 'inline'\n  /** label 宽度 */\n  labelCol?: { span: number; offset?: number }\n  /** 输入框宽度 */\n  wrapperCol?: { span: number; offset?: number }\n  /** 是否在关闭时重置表单 */\n  resetOnClose?: boolean\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  modal: undefined,\n  rules: () => ({}),\n  layout: 'vertical',\n  labelCol: undefined,\n  wrapperCol: undefined,\n  resetOnClose: true\n})\n\nconst emit = defineEmits<{\n  ok: [values: Record<string, any>]\n  cancel: []\n}>()\n\n// 如果传递了 modal prop，使用它；否则创建新的实例\nconst modal = props.modal || useModal()\nconst formRef = ref<FormInstance>()\n\n// 获取业务数据作为表单初始值\nconst formData = reactive<Record<string, any>>({})\n\nconst extractFormData = () => {\n  const args = toRaw(modal.args.value)\n  if (args.data && typeof args.data === 'object') {\n    return toRaw(args.data) as Record<string, any>\n  }\n  return toRaw(modal.getFormData())\n}\n\nconst assignFormData = (source: Record<string, any>) => {\n  const keys = Object.keys(formData)\n  keys.forEach(key => {\n    if (!(key in source)) {\n      delete formData[key]\n    }\n  })\n  Object.assign(formData, source)\n}\n\nconst previousVisible = ref(false)\n\nwatchEffect(() => {\n  const visible = modal.visible.value\n\n  if (visible) {\n    assignFormData(extractFormData())\n    nextTick(() => {\n      formRef.value?.clearValidate()\n    })\n  } else if (previousVisible.value && props.resetOnClose) {\n    assignFormData({})\n    nextTick(() => {\n      formRef.value?.resetFields()\n      formRef.value?.clearValidate()\n    })\n  }\n\n  previousVisible.value = visible\n})\n\n// 处理确认\nconst handleOk = async () => {\n  if (!formRef.value) {\n    modal.hide()\n    return\n  }\n\n  try {\n    // 验证表单\n    await formRef.value.validate()\n\n    // 触发 ok 事件，传递表单数据\n    emit('ok', { ...formData })\n  } catch (error) {\n    console.error('表单验证失败:', error)\n  }\n}\n\n// 处理取消\nconst handleCancel = () => {\n  emit('cancel')\n  modal.hide()\n}\n\n// 暴露表单实例和方法\ndefineExpose({\n  formRef,\n  formData,\n  validate: () => formRef.value?.validate(),\n  resetFields: () => formRef.value?.resetFields(),\n  clearValidate: () => formRef.value?.clearValidate(),\n  getFieldsValue: () => formRef.value?.getFieldsValue()\n})\n</script>\n"
    },
    {
      "path": "src/components/MxModal/MxDetailModal.vue",
      "content": "<!--\n * @Author: liaokt\n * @Description: 通用详情弹窗组件\n * @Date: 2025-11-13 17:00:00\n * @LastEditors: liaokt\n * @LastEditTime: 2025-11-13 17:00:00\n-->\n<template>\n  <MxModal :modal=\"modal\" :show-ok=\"showOk\" :show-cancel=\"showCancel\">\n    <div :class=\"['mx-detail-modal', customClass]\">\n      <slot name=\"header\" :data=\"detailData\" />\n\n      <MxFormRow :cols=\"cols\" :gutter=\"gutter\" class=\"mx-detail-modal__grid\">\n        <div\n          v-for=\"item in normalizedItems\"\n          :key=\"item.key\"\n          class=\"mx-detail-modal__item\"\n          :class=\"{\n            'mx-detail-modal__item--full': item.span === 24,\n            'mx-detail-modal__item--empty': item.isPlaceholder\n          }\"\n          :data-span=\"item.span\"\n        >\n          <slot name=\"label\" :item=\"item\" :data=\"detailData\">\n            <div class=\"mx-detail-modal__label\">{{ item.label }}</div>\n          </slot>\n\n          <div :class=\"['mx-detail-modal__value', item.valueClass]\">\n            <template v-if=\"$slots[`value-${item.key}`]\">\n              <slot :name=\"`value-${item.key}`\" :item=\"item\" :data=\"detailData\" />\n            </template>\n            <template v-else-if=\"$slots.value\">\n              <slot name=\"value\" :item=\"item\" :data=\"detailData\" />\n            </template>\n            <template v-else-if=\"item.component\">\n              <component :is=\"item.component\" v-bind=\"item.componentProps\" />\n            </template>\n            <template v-else-if=\"item.type === 'tag'\">\n              <a-tag v-if=\"!item.isPlaceholder\" :color=\"item.tagColor || tagColor\">\n                {{ item.display }}\n              </a-tag>\n              <span v-else>{{ placeholder }}</span>\n            </template>\n            <template v-else>\n              {{ item.display }}\n            </template>\n          </div>\n        </div>\n      </MxFormRow>\n    </div>\n\n    <template v-if=\"$slots.footer\" #footer>\n      <slot name=\"footer\" :data=\"detailData\" />\n    </template>\n  </MxModal>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed, type Component } from 'vue'\nimport { MxModal, useModal, type UseModalReturn } from '@/components/MxModal'\nimport { MxFormRow } from '@/components/MxFormLayout'\n\ndefineOptions({\n  name: 'MxDetailModal'\n})\n\ntype DetailValueType = 'default' | 'tag' | 'code' | 'block'\n\nexport interface DetailField {\n  key: string\n  label: string\n  span?: number\n  type?: DetailValueType\n  suffix?: string\n  formatter?: (value: unknown, data: Record<string, any>) => string\n  tagColor?: string\n  component?: Component\n  componentProps?: Record<string, any>\n}\n\ninterface NormalizedItem extends DetailField {\n  display: string\n  rawValue: unknown\n  valueClass?: string\n  isPlaceholder: boolean\n}\n\ninterface Props {\n  modal?: UseModalReturn\n  /** 详情字段配置 */\n  fields: DetailField[]\n  /** 详情数据（不传则自动从 modal 参数中获取） */\n  data?: Record<string, any>\n  /** 列数 */\n  cols?: number\n  /** 间距 */\n  gutter?: number | [number, number]\n  /** 占位符 */\n  placeholder?: string\n  /** 默认标签颜色 */\n  tagColor?: string\n  /** 自定义根样式类 */\n  customClass?: string\n  /** 是否显示确认按钮 */\n  showOk?: boolean\n  /** 是否显示取消按钮 */\n  showCancel?: boolean\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  modal: undefined,\n  fields: () => [] as DetailField[],\n  data: undefined,\n  cols: 2,\n  gutter: () => [32, 24] as [number, number],\n  placeholder: '-',\n  tagColor: 'blue',\n  customClass: '',\n  showOk: false,\n  showCancel: false\n})\n\nconst modal = props.modal || useModal()\n\nconst detailData = computed<Record<string, any>>(() => {\n  if (props.data) {\n    return props.data\n  }\n  const args = modal.args.value\n  if (args.data && typeof args.data === 'object') {\n    return args.data as Record<string, any>\n  }\n  return modal.getFormData()\n})\n\nconst placeholder = computed(() => props.placeholder)\nconst tagColor = computed(() => props.tagColor)\nconst cols = computed(() => props.cols)\nconst gutter = computed(() => props.gutter)\nconst customClass = computed(() => props.customClass)\nconst showOk = computed(() => props.showOk)\nconst showCancel = computed(() => props.showCancel)\n\nconst valueClassMap: Record<DetailValueType, string | undefined> = {\n  default: undefined,\n  tag: 'mx-detail-modal__value--tag',\n  code: 'mx-detail-modal__value--code',\n  block: 'mx-detail-modal__value--block'\n}\n\nconst hasValue = (value: unknown): boolean => {\n  return !(value === null || value === undefined || value === '')\n}\n\nconst formatValue = (field: DetailField, value: unknown): string => {\n  if (field.formatter) {\n    return field.formatter(value, detailData.value)\n  }\n  if (!hasValue(value)) {\n    return placeholder.value\n  }\n  if (field.suffix) {\n    return `${value}${field.suffix}`\n  }\n  return String(value)\n}\n\nconst normalizedItems = computed<NormalizedItem[]>(() => {\n  return props.fields.map(field => {\n    const rawValue = detailData.value?.[field.key]\n    const display = formatValue(field, rawValue)\n    return {\n      ...field,\n      display,\n      rawValue,\n      isPlaceholder: display === placeholder.value,\n      valueClass: field.type ? valueClassMap[field.type] : undefined,\n      componentProps: {\n        ...field.componentProps,\n        value: rawValue,\n        data: detailData.value,\n        field\n      }\n    }\n  })\n})\n</script>\n\n<style scoped lang=\"scss\">\n.mx-detail-modal {\n  min-width: 520px;\n\n  &__grid {\n    margin-bottom: 24px;\n\n    :deep(.ant-row) {\n      width: 100%;\n    }\n  }\n\n  &__item {\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n\n    &--full {\n      width: 100%;\n    }\n  }\n\n  &__label {\n    color: #6f6f6f;\n    font-size: 13px;\n    font-weight: 500;\n    line-height: 1.6;\n  }\n\n  &__value {\n    color: #1f1f1f;\n    font-size: 14px;\n    font-weight: 500;\n    line-height: 1.6;\n    word-break: break-word;\n\n    &--tag {\n      display: inline-flex;\n      align-items: center;\n\n      :deep(.ant-tag) {\n        margin-inline-end: 0;\n        padding: 3px 12px;\n        border-radius: 4px;\n        font-size: 13px;\n        font-weight: 500;\n        line-height: 22px;\n      }\n    }\n\n    &--code {\n      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New',\n        monospace;\n      font-size: 14px;\n      letter-spacing: 0.6px;\n      color: #3f3f3f;\n    }\n\n    &--block {\n      display: inline-block;\n      padding: 12px 16px;\n      background: #fafafa;\n      border: 1px solid #f0f0f0;\n      border-radius: 4px;\n      font-size: 14px;\n      font-weight: 500;\n      color: #3f3f3f;\n      line-height: 1.7;\n    }\n  }\n}\n</style>\n"
    },
    {
      "path": "src/components/MxModal/README.md",
      "content": "# MxModal 命令式弹窗系统\n\n类似 `@ebay/nice-modal-react` 的命令式弹窗方案，使用 Context Provider 全局管理 Modal 状态。\n\n## 特性\n\n- ✅ 命令式 API，无需在模板中声明组件\n- ✅ 全局状态管理，通过 Provider 统一管理\n- ✅ 支持 Promise，可以等待用户操作结果\n- ✅ 自动注册，无需手动管理\n- ✅ 类型安全，完整的 TypeScript 支持\n- ✅ 封装了 `MxFormModal`，简化表单弹窗开发\n- ✅ 自动区分业务数据和 `a-modal` 参数\n\n## 快速开始\n\n### 1. 在 App 中包裹 Provider\n\n```vue\n<!-- App.vue -->\n<template>\n  <a-config-provider :theme=\"themeConfig\" :locale=\"locale\">\n    <MxModalProvider>\n      <router-view />\n    </MxModalProvider>\n  </a-config-provider>\n</template>\n\n<script setup lang=\"ts\">\nimport { MxModalProvider } from '@/components/MxModal'\n</script>\n```\n\n### 2. 创建 Modal 组件\n\n#### 方式1：使用 MxFormModal（推荐，适用于表单场景）\n\n```vue\n<!-- components/UserModal.vue -->\n<template>\n  <MxFormModal :modal=\"modal\" :rules=\"rules\" layout=\"vertical\" @ok=\"handleSubmit\">\n    <template #default=\"{ formData }\">\n      <a-form-item label=\"姓名\" name=\"name\" required>\n        <a-input v-model:value=\"formData.name\" placeholder=\"请输入姓名\" />\n      </a-form-item>\n      <a-form-item label=\"年龄\" name=\"age\" required>\n        <a-input-number v-model:value=\"formData.age\" :min=\"0\" style=\"width: 100%\" />\n      </a-form-item>\n    </template>\n  </MxFormModal>\n</template>\n\n<script setup lang=\"ts\">\nimport { MxFormModal, useModal } from '@/components/MxModal'\nimport type { UseModalReturn } from '@/components/MxModal/useModal'\nimport type { Rule } from 'ant-design-vue/es/form'\n\ninterface Props {\n  modal?: UseModalReturn\n}\n\nconst props = defineProps<Props>()\nconst modal = props.modal || useModal()\n\n// 表单验证规则\nconst rules: Record<string, Rule[]> = {\n  name: [{ required: true, message: '请输入姓名', trigger: 'blur' }],\n  age: [{ required: true, message: '请输入年龄', trigger: 'blur' }]\n}\n\n// 处理提交（确认按钮事件入口）\nconst handleSubmit = async (values: Record<string, any>) => {\n  try {\n    // 在这里调用接口\n    // const result = await api.addUser(values)\n\n    // 接口成功后，关闭弹窗\n    modal.resolve(values)\n    modal.hide()\n  } catch (error) {\n    // 接口失败，不关闭弹窗（让用户看到错误信息）\n    console.error('提交失败:', error)\n  }\n}\n</script>\n```\n\n#### 方式2：使用 MxModal（适用于非表单场景）\n\n```vue\n<!-- components/ConfirmModal.vue -->\n<template>\n  <MxModal :modal=\"modal\" @ok=\"handleOk\" @cancel=\"handleCancel\">\n    <p>{{ message }}</p>\n  </MxModal>\n</template>\n\n<script setup lang=\"ts\">\nimport { MxModal, useModal } from '@/components/MxModal'\nimport type { UseModalReturn } from '@/components/MxModal/useModal'\n\ninterface Props {\n  modal?: UseModalReturn\n  message?: string\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  message: '确认执行此操作？'\n})\n\nconst modal = props.modal || useModal()\n\nconst handleOk = () => {\n  modal.resolve(true)\n  modal.hide()\n}\n\nconst handleCancel = () => {\n  modal.hide()\n}\n</script>\n```\n\n#### 方式3：直接使用 a-modal（高级用法）\n\n```vue\n<!-- components/UserModal.vue -->\n<template>\n  <a-modal\n    :open=\"modal.visible.value\"\n    v-bind=\"modalProps\"\n    @cancel=\"modal.hide()\"\n    @after-close=\"modal.remove()\"\n    @ok=\"handleOk\"\n  >\n    <a-form :model=\"formData\" layout=\"vertical\">\n      <a-form-item label=\"姓名\" name=\"name\" required>\n        <a-input v-model:value=\"formData.name\" placeholder=\"请输入姓名\" />\n      </a-form-item>\n      <a-form-item label=\"年龄\" name=\"age\" required>\n        <a-input-number v-model:value=\"formData.age\" :min=\"0\" style=\"width: 100%\" />\n      </a-form-item>\n    </a-form>\n  </a-modal>\n</template>\n\n<script setup lang=\"ts\">\nimport { reactive, computed } from 'vue'\nimport { useModal } from '@/components/MxModal'\nimport type { ModalProps } from 'ant-design-vue'\n\nconst modal = useModal()\n\n// 使用 getFormData 获取业务数据（自动排除 a-modal 参数）\nconst formData = reactive({\n  name: '',\n  age: undefined,\n  ...modal.getFormData<{ name: string; age: number }>()\n})\n\n// 使用 getModalProps 获取 a-modal 参数（自动提取）\nconst modalProps = computed<ModalProps>(() => ({\n  title: '用户信息',\n  width: 600,\n  ...modal.getModalProps() // 自动提取所有 a-modal 的参数\n}))\n\nconst handleOk = () => {\n  // 提交数据并关闭\n  modal.resolve({ ...formData })\n  modal.hide()\n}\n</script>\n```\n\n### 3. 使用 Modal（无需注册）\n\n```vue\n<!-- views/UserList.vue -->\n<template>\n  <mx-button @click=\"handleAdd\">新增用户</mx-button>\n</template>\n\n<script setup lang=\"ts\">\nimport { useModalController } from '@/components/MxModal'\nimport UserModal from '@/components/UserModal.vue'\n\n// 创建 Modal 控制器（自动注册）\nconst modal = useModalController(UserModal)\n\nconst handleAdd = async () => {\n  // 可以传递业务数据和 a-modal 的参数\n  const result = await modal.show({\n    // 业务数据\n    name: '',\n    age: 0,\n    // a-modal 的参数（可选）\n    title: '新增用户',\n    width: 800,\n    okText: '保存',\n    cancelText: '取消',\n    maskClosable: false\n  })\n\n  if (result) {\n    console.log('用户提交的数据:', result)\n    // 调用 API 保存数据\n  }\n}\n</script>\n```\n\n## API\n\n### MxModalProvider\n\n全局 Provider 组件，需要在 App 根组件中包裹。\n\n### useModal()\n\n在 Modal 组件内部使用的 Hook，返回：\n\n- `visible: Ref<boolean>` - Modal 是否可见\n- `args: Ref<Record<string, any>>` - Modal 参数（包含业务数据和 a-modal 参数）\n- `show(args?)` - 显示 Modal\n- `hide()` - 隐藏 Modal\n- `remove()` - 移除 Modal\n- `update(args)` - 更新参数\n- `resolve(value)` - 解析 Promise（用于命令式调用，将数据返回给调用者）\n- `reject(reason)` - 拒绝 Promise\n- `getFormData<T>(keys?)` - 获取业务数据（自动排除 a-modal 参数）\n  - `keys?: string[]` - 可选，指定要获取的字段，不传则返回所有业务数据\n- `getModalProps()` - 获取 a-modal 的参数（自动提取）\n\n### useModalController(component)\n\n创建 Modal 控制器（推荐使用），自动注册组件，返回：\n\n- `show(args?)` - 显示 Modal，返回 Promise\n  - `args` 可以包含业务数据和 `a-modal` 的所有参数（如 `title`, `width`, `okText`, `cancelText`, `maskClosable` 等）\n- `hide()` - 隐藏 Modal\n- `remove()` - 移除 Modal\n\n```ts\nconst modal = useModalController(UserModal)\n\n// 传递业务数据和 a-modal 参数\nconst result = await modal.show({\n  // 业务数据\n  userId: 123,\n  // a-modal 参数（可选）\n  title: '编辑用户',\n  width: 800,\n  okText: '确定',\n  cancelText: '取消'\n})\n```\n\n**注意**：\n\n- 如果使用 `MxFormModal` 或 `MxModal`，它们会自动处理 `a-modal` 参数的绑定\n- 如果直接使用 `a-modal`，需要通过 `modal.args.value` 访问这些参数，并使用 `v-bind` 绑定到 `a-modal` 上\n\n### removeAll()\n\n移除所有 Modal。\n\n## 完整示例\n\n```vue\n<!-- views/UserList.vue -->\n<template>\n  <mx-button @click=\"handleAdd\">新增用户</mx-button>\n</template>\n\n<script setup lang=\"ts\">\nimport { useModalController } from '@/components/MxModal'\nimport UserModal from '@/components/UserModal.vue'\n\n// 创建 Modal 控制器\nconst modal = useModalController(UserModal)\n\nconst handleAdd = async () => {\n  const result = await modal.show({ name: '', age: 0 })\n\n  if (result) {\n    console.log('用户提交的数据:', result)\n    // 调用 API 保存数据\n  } else {\n    // 用户取消了操作\n    console.log('用户取消了操作')\n  }\n}\n</script>\n```\n"
    }
  ]
}
